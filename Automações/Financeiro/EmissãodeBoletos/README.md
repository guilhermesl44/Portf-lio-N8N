# üí≥ Sistema de Cobran√ßa Automatizada com Banco Inter

> **Categoria:** Financeiro | **Complexidade:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | **Status:** ‚úÖ Em Produ√ß√£o

## üìù Vis√£o Geral

Criei este workflow para automatizar completamente o processo de cobran√ßa recorrente usando a API do Banco Inter. O sistema gerencia todo o ciclo: desde a gera√ß√£o dos boletos at√© o envio por email e atualiza√ß√£o de status baseada em callbacks do banco.

O diferencial √© que tudo acontece automaticamente - o workflow roda diariamente, gera os boletos conforme a data de envio programada, envia por email com template personalizado e atualiza os status quando o cliente paga ou o boleto atrasa.

## üéØ Por Que Criei Esta Automa√ß√£o

**O problema:**
- Gerar boletos manualmente para dezenas de clientes √© trabalhoso
- Enviar boletos por email um por um consome horas
- Controlar status de pagamento manualmente gera erros
- Atualizar planilhas de cobran√ßa √© repetitivo e sujeito a falhas
- Perder datas de envio prejudica o fluxo de caixa

**A solu√ß√£o:**
Um sistema 100% automatizado que:
- Roda diariamente e verifica quais boletos devem ser enviados
- Gera boletos automaticamente via API do Banco Inter
- Envia emails com template profissional e boleto anexo
- Recebe callbacks do banco quando h√° mudan√ßas (pagamento, atraso, etc)
- Atualiza automaticamente todas as planilhas de controle

## üèóÔ∏è Como Funciona

### Fluxo Principal (Agendado Diariamente)

```
1. Schedule Trigger (09:05 AM)
   ‚Üì
2. Busca clientes no Google Sheets
   ‚Üì
3. Para cada cliente:
   ‚îú‚îÄ Atualiza status para "VERIFICANDO"
   ‚îú‚îÄ Calcula data de vencimento
   ‚îú‚îÄ Verifica se j√° existe cobran√ßa
   ‚îú‚îÄ Se n√£o existe, cria nova
   ‚îú‚îÄ Verifica se √© data de envio
   ‚îî‚îÄ Se sim, processa envio
   ‚Üì
4. Processo de Envio:
   ‚îú‚îÄ Autentica no Banco Inter (token OAuth2)
   ‚îú‚îÄ Gera boleto via API (se n√£o existir)
   ‚îú‚îÄ Busca PDF do boleto
   ‚îú‚îÄ Envia email com template HTML
   ‚îî‚îÄ Atualiza status para "PENDENTE"
   ‚Üì
5. Aguarda 6 segundos e processa pr√≥ximo cliente
```

### Fluxo de Callbacks (Webhook)

```
1. Banco Inter envia callback
   ‚Üì
2. Identifica tipo de evento:
   ‚îú‚îÄ PAGO ‚Üí Atualiza status + pr√≥ximo m√™s
   ‚îú‚îÄ ATRASADO ‚Üí Marca pend√™ncia
   ‚îú‚îÄ CANCELADO ‚Üí Libera pr√≥ximo m√™s
   ‚îî‚îÄ EXPIRADO ‚Üí Libera pr√≥ximo m√™s
   ‚Üì
3. Atualiza Google Sheets
   ‚îú‚îÄ Aba "Emiss√µes" (status do boleto)
   ‚îî‚îÄ Aba "Clientes" (status e pr√≥xima cobran√ßa)
```

### Diagrama Visual

![Fluxo Completo](./Imagens/EMISSAODEBOLETOS.jpg)

*Nota: Por quest√µes de confidencialidade, o arquivo JSON n√£o est√° dispon√≠vel publicamente.*

## ‚öôÔ∏è Componentes e Integra√ß√µes

### Tecnologias Utilizadas:
- **N8N:** Plataforma de automa√ß√£o
- **Banco Inter API:** Gera√ß√£o e gest√£o de boletos
- **Google Sheets:** Banco de dados de clientes e cobran√ßas
- **Gmail:** Envio de emails com templates
- **Redis:** Cache de tokens de autentica√ß√£o
- **Webhook:** Recebimento de callbacks

### Principais Nodes:
- **Schedule Trigger:** Execu√ß√£o di√°ria √†s 09:05
- **Webhook (2x):** Callbacks e trigger manual de atualiza√ß√£o
- **Google Sheets (9x):** Leitura e atualiza√ß√£o de dados
- **HTTP Request (3x):** Chamadas √† API do Banco Inter
- **Gmail:** Envio de emails
- **Redis (3x):** Gerenciamento de token OAuth2
- **IF/Switch (8x):** L√≥gica condicional
- **Wait (4x):** Delays entre requisi√ß√µes
- **Split In Batches:** Loop pelos clientes
- **Code:** C√°lculos de datas e IDs

## üîß Funcionalidades Principais

### 1. Gest√£o Inteligente de Tokens OAuth2

O Banco Inter usa autentica√ß√£o OAuth2 com tokens que expiram. Criei um sistema de cache:

**Como funciona:**
1. Antes de qualquer requisi√ß√£o, busca token no Redis
2. Se n√£o existir ou estiver expirado, solicita novo
3. Armazena no Redis com TTL de 50 minutos
4. Reutiliza o mesmo token em todas as requisi√ß√µes

**Por que √© importante:**
Evita fazer autentica√ß√£o a cada requisi√ß√£o, economizando tempo e prevenindo rate limiting.

**C√≥digo de exemplo:**
```javascript
// Busca token no cache
token = await redis.get('banco_inter_token')

// Se n√£o existe, autentica
if (!token) {
  token = await requestNewToken()
  await redis.set('banco_inter_token', token, { ttl: 3000 })
}
```

### 2. Sistema de Cobran√ßa Dupla Verifica√ß√£o

Antes de gerar um boleto, o sistema verifica se j√° existe:

**Fluxo de verifica√ß√£o:**
1. Calcula ID √∫nico: `diaVencimento + m√™s + ano + CPF/CNPJ`
2. Busca na aba "Emiss√µes" por este ID
3. Se existe: reutiliza dados existentes
4. Se n√£o existe: cria novo registro

**Por que √© importante:**
Evita duplica√ß√£o de boletos para o mesmo cliente/m√™s.

### 3. C√°lculo Autom√°tico de Datas

O sistema calcula automaticamente v√°rias datas:

**Data de Vencimento:**
```javascript
vencimento = `${ano}-${mesProxCobran√ßa}-${diaVencimento}`
// Exemplo: 2025-11-15
```

**Data de Envio (antecipada):**
```javascript
dataEnvio = WORKDAY(vencimento, -numDiasAntecedencia)
// Usa fun√ß√£o WORKDAY do Sheets para excluir fins de semana
```

**Verifica√ß√£o di√°ria:**
```javascript
if (dataEnvio === dataAtual) {
  // Processa envio do boleto
}
```

### 4. Gera√ß√£o de Boletos via API

Integra√ß√£o completa com API do Banco Inter:

**Payload enviado:**
```json
{
  "valorNominal": "150.00",
  "seuNumero": "1-15-11-2025",
  "dataVencimento": "2025-11-15",
  "numDiasAgenda": "60",
  "pagador": {
    "cpfCnpj": "12345678901",
    "tipoPessoa": "FISICA",
    "nome": "Cliente Exemplo",
    "endereco": "Rua Exemplo, 123",
    "cidade": "S√£o Paulo",
    "uf": "SP",
    "cep": "01234567",
    "bairro": "Centro"
  },
  "multa": {
    "codigo": "PERCENTUAL",
    "taxa": "2.00"
  },
  "mora": {
    "codigo": "TAXAMENSAL",
    "taxa": "1.00"
  }
}
```

**Resposta:**
```json
{
  "codigoSolicitacao": "00000000-0000-0000-0000-000000000000"
}
```

### 5. Busca e Convers√£o de PDF

Ap√≥s gerar o boleto, busca o PDF:

**Processo:**
1. Requisi√ß√£o para endpoint `/pdf` com `codigoSolicitacao`
2. Recebe PDF em Base64
3. Converte para arquivo bin√°rio
4. Armazena o Base64 no Google Sheets (opcional: upload para Supabase)

**C√≥digo de convers√£o:**
```javascript
// Edit Fields11: prepara dados
{
  pdf: base64String,
  fileName: codigoSolicitacao + ".pdf",
  mimeType: "application/pdf"
}

// Convert to File: transforma em bin√°rio
binaryData = convertBase64ToBinary(pdf)
```

### 6. Template de Email Profissional

Email HTML responsivo com todas as informa√ß√µes:

**Estrutura do template:**
- Header com logo/imagem
- Sauda√ß√£o personalizada
- Tabela com dados do boleto (valor, vencimento, refer√™ncia)
- Informa√ß√£o sobre anexo
- Se√ß√£o de confirma√ß√£o de recebimento
- Se√ß√£o de suporte
- Assinatura
- Footer

**Personaliza√ß√£o autom√°tica:**
```javascript
Subject: BOLETO [NOME_M√äS] [ANO]
Para: cliente@email.com
CC: copia@email.com (se configurado)
Anexo: PDF do boleto
```

### 7. Sistema de Callbacks do Banco

O Banco Inter envia callbacks quando h√° mudan√ßas:

**Tipos de eventos:**
- **RECEBIDO** (PAGO): Cliente pagou
- **ATRASADO**: Passou da data de vencimento
- **CANCELADO**: Boleto foi cancelado
- **EXPIRADO**: Boleto expirou

**Processamento:**
```javascript
switch (situacao) {
  case 'RECEBIDO':
    status = 'PAGO'
    mesProxCobran√ßa = mesAtual + 1
    clientStatus = 'OK'
    break
    
  case 'ATRASADO':
    status = 'ATRASADO'
    mesProxCobran√ßa = mesAtual // N√£o avan√ßa
    clientStatus = 'PENDENCIA'
    break
    
  case 'CANCELADO':
  case 'EXPIRADO':
    status = 'CANCELADO'
    mesProxCobran√ßa = mesAtual + 1
    clientStatus = 'OK'
    break
}
```

### 8. Rate Limiting Inteligente

A API do Banco Inter tem limites de requisi√ß√µes. Implementei delays:

**Estrat√©gia:**
```javascript
rateLimit = 6 segundos // Configur√°vel

// Entre cada requisi√ß√£o √† API
await wait(rateLimit)

// Entre cada cliente processado
await wait(rateLimit)
```

**Por que 6 segundos:**
- API do Banco Inter permite ~10 req/min
- 6 segundos = seguran√ßa para n√£o bater no limite
- Processamento controlado e est√°vel

## üìä Estrutura do Google Sheets

### Aba "Clientes"

| Coluna | Descri√ß√£o |
|--------|-----------|
| email | Email do cliente |
| cpfCnpj | CPF ou CNPJ |
| tipoPessoa | FISICA ou JURIDICA |
| nome | Nome completo/raz√£o social |
| endereco | Endere√ßo completo |
| cidade | Cidade |
| uf | Estado (sigla) |
| cep | CEP |
| bairro | Bairro |
| valor | Valor da cobran√ßa mensal |
| diaVencimento | Dia do vencimento (1-31) |
| mesProxCobran√ßa | Pr√≥ximo m√™s a cobrar (1-12) |
| status | Status atual (OK, VERIFICANDO, PENDENCIA) |
| CC | Emails em c√≥pia (separados por v√≠rgula) |

### Aba "Emiss√µes"

| Coluna | Descri√ß√£o |
|--------|-----------|
| id | ID √∫nico da cobran√ßa |
| numero | N√∫mero de refer√™ncia |
| nome | Nome do cliente |
| cpfCnpj | CPF/CNPJ |
| valor | Valor do boleto |
| vencimento | Data de vencimento (f√≥rmula) |
| dataEnvio | Data programada envio (f√≥rmula) |
| codigoSolicitacao | C√≥digo retornado pelo banco |
| boleto | PDF em Base64 |
| status | AGUARDANDO, PENDENTE, PAGO, ATRASADO, ERRO |
| mensagem | Mensagem de erro/sucesso |

### Aba "Configura√ß√£o"

| Coluna | Descri√ß√£o |
|--------|-----------|
| dataAtual | Data atual (f√≥rmula: TODAY()) |
| competencia | M√™s/ano da compet√™ncia |
| numDiasAntecedencia | Dias antes para enviar |
| numDiasAgenda | Dias ap√≥s vencimento |
| multa | % de multa |
| mora | % de mora mensal |

## üîÑ Ciclo Completo de uma Cobran√ßa

**Dia -7 (envio programado):**
1. Workflow roda √†s 09:05
2. Verifica que √© data de envio
3. Autentica no Banco Inter
4. Gera boleto via API
5. Busca PDF
6. Envia email com boleto
7. Status: AGUARDANDO ‚Üí PENDENTE

**Dia 0 (vencimento):**
- Boleto dispon√≠vel para pagamento
- Status permanece: PENDENTE

**Cliente paga:**
1. Banco Inter envia callback
2. Webhook recebe: situacao = "RECEBIDO"
3. Atualiza status: PAGO
4. Avan√ßa m√™s: mesProxCobran√ßa + 1
5. Status do cliente: OK

**Cliente n√£o paga (ap√≥s vencimento):**
1. Banco Inter envia callback
2. Webhook recebe: situacao = "ATRASADO"
3. Atualiza status: ATRASADO
4. N√£o avan√ßa m√™s
5. Status do cliente: PENDENCIA

## üõ°Ô∏è Tratamento de Erros

### Autentica√ß√£o:
```javascript
// Se falhar autentica√ß√£o
onError: continueErrorOutput
// Retorna: sucesso = false, mensagem = "Falha na autentica√ß√£o"
```

### Gera√ß√£o de Boleto:
```javascript
// Se falhar gera√ß√£o
retryOnFail: true
waitBetweenTries: 5000 // 5 segundos
// Tenta 3x antes de desistir
```

### Envio de Email:
```javascript
// Se falhar envio
onError: continueErrorOutput
// Marca status: ERRO
// Mensagem: "Erro ao enviar o boleto por e-mail"
```

### Fluxo com Erro:
```
Erro detectado
  ‚Üì
Status marcado: ERRO
  ‚Üì
Cliente status: PENDENCIA
  ‚Üì
Pr√≥xima execu√ß√£o: tenta novamente
```

## üéì Conceitos T√©cnicos Aplicados

### Autentica√ß√£o OAuth2:
- Client Credentials Grant
- Token caching com TTL
- Refresh autom√°tico

### API REST Integration:
- POST para criar recursos
- GET para buscar dados
- Headers de autentica√ß√£o
- Certificados SSL

### Webhook Handling:
- Recebimento de callbacks
- Valida√ß√£o de payloads
- Processamento ass√≠ncrono

### Batch Processing:
- Loop controlado por cliente
- Rate limiting entre requisi√ß√µes
- Agrega√ß√£o de resultados

### Template Engine:
- HTML din√¢mico com interpola√ß√£o
- Formata√ß√£o de dados (moeda, data)
- Condicional rendering

## üíª Configura√ß√£o Necess√°ria

### Credenciais do Banco Inter:

```javascript
{
  baseUrl: "https://cdpj.partners.bancointer.com.br",
  clientId: "SEU_CLIENT_ID",
  clientSecret: "SEU_CLIENT_SECRET",
  contaCorrente: "SUA_CONTA",
  rateLimit: 6
}
```

### Certificado SSL:
- Obrigat√≥rio para API do Banco Inter
- Arquivo .crt e .key fornecidos pelo banco
- Configurar no N8N em SSL Certificates

### Redis:
- Host e porta
- Usado para cache de token

### Google Sheets:
- OAuth2 configurado
- Permiss√µes de leitura/escrita

### Gmail:
- OAuth2 configurado
- Permiss√µes de envio

## üöÄ Como Usar

### Configura√ß√£o Inicial:

1. **Configure as credenciais** no node "Set Credenciais"
2. **Ajuste a planilha** com estrutura descrita
3. **Configure webhook** do Banco Inter para apontar para sua URL
4. **Teste manualmente** antes de ativar o schedule

### Adicionando Novo Cliente:

1. Adicione linha na aba "Clientes"
2. Preencha todos os campos obrigat√≥rios
3. Defina `diaVencimento` e `mesProxCobran√ßa`
4. Status inicial: deixe em branco

### Monitoramento:

- Aba "Emiss√µes": ver status de cada boleto
- Aba "Clientes": ver status de cada cliente
- Logs do N8N: detalhes de execu√ß√£o

## ‚ö†Ô∏è Limita√ß√µes e Considera√ß√µes

### Limita√ß√µes da API:
- ~10 requisi√ß√µes por minuto
- Certificado SSL obrigat√≥rio
- Boletos s√≥ podem ser gerados X dias antes do vencimento
- PDF dispon√≠vel apenas ap√≥s gera√ß√£o bem-sucedida

### Boas Pr√°ticas:
- N√£o processar muitos clientes de uma vez
- Monitorar logs regularmente
- Manter backup da planilha
- Testar mudan√ßas em ambiente separado
- Verificar status dos emails enviados

### Custos:
- API do Banco Inter (consulte tabela do banco)
- Cr√©ditos de envio de email (Gmail API)
- Infraestrutura N8N
- Armazenamento (se usar Supabase)

## üìö Aprendizados

### O que funcionou bem:
- Cache de token reduziu lat√™ncia significativamente
- Delays entre requisi√ß√µes preveniram bloqueios
- Callbacks garantem sincroniza√ß√£o em tempo real
- Template de email profissional aumentou confian√ßa
- Sistema de dupla verifica√ß√£o evitou duplicatas

### Desafios que enfrentei:
- Configura√ß√£o correta dos certificados SSL
- Entender fluxo OAuth2 do Banco Inter
- Sincronizar status entre m√∫ltiplas planilhas
- Lidar com diferentes cen√°rios de erro
- Garantir idempot√™ncia nas opera√ß√µes

### Melhorias que planejo:
- Dashboard de m√©tricas em tempo real
- Notifica√ß√µes via Slack para erros cr√≠ticos
- Retry inteligente baseado em tipo de erro
- Hist√≥rico de todas as tentativas
- Relat√≥rios mensais automatizados

---

## üìÑ Notas Importantes

> ‚ö†Ô∏è **Confidencialidade:** O c√≥digo-fonte (JSON) e credenciais n√£o est√£o dispon√≠veis publicamente.

> üè¶ **Homologa√ß√£o:** Certifique-se de testar em ambiente de homologa√ß√£o do banco antes de produ√ß√£o.

> üíº **Compliance:** Este workflow lida com dados financeiros sens√≠veis. Garanta conformidade com LGPD e regula√ß√µes banc√°rias.

> üîí **Seguran√ßa:** Nunca commite credenciais no Git. Use vari√°veis de ambiente ou cofre de senhas.

---

**Criado em:** 2025  
**√öltima atualiza√ß√£o:** 13/10/2025  
**Status:** ‚úÖ Em produ√ß√£o  
**Integra√ß√£o:** Banco Inter API v3
